---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.20.0
  name: upgraderequests.fluxup.dev
spec:
  group: fluxup.dev
  names:
    kind: UpgradeRequest
    listKind: UpgradeRequestList
    plural: upgraderequests
    singular: upgraderequest
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.conditions[?(@.type=='Complete')].status
      name: Complete
      type: string
    - jsonPath: .status.conditions[?(@.type=='Complete')].reason
      name: Reason
      type: string
    - jsonPath: .spec.managedAppRef.name
      name: ManagedApp
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: UpgradeRequest is the Schema for the upgraderequests API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: UpgradeRequestSpec defines the desired state of UpgradeRequest
            properties:
              dryRun:
                default: false
                description: Dry run - validate only, don't apply
                type: boolean
              managedAppRef:
                description: Reference to the ManagedApp to upgrade
                properties:
                  name:
                    type: string
                  namespace:
                    type: string
                required:
                - name
                type: object
              skipSnapshot:
                default: false
                description: Skip snapshot creation (not recommended)
                type: boolean
              targetVersion:
                description: Target version (optional - uses latest available if empty)
                properties:
                  chart:
                    description: Chart version (for HelmRelease)
                    type: string
                  images:
                    description: Image versions (for raw deployments or helm values)
                    items:
                      description: ImageInfo contains image version details
                      properties:
                        name:
                          type: string
                        tag:
                          type: string
                      required:
                      - name
                      - tag
                      type: object
                    type: array
                type: object
            required:
            - managedAppRef
            type: object
          status:
            description: |-
              UpgradeRequestStatus defines the observed state of UpgradeRequest
              Progress is tracked via conditions (no phase field - following K8s API conventions)
            properties:
              conditions:
                description: |-
                  Conditions represent the current state of the upgrade.
                  The controller determines the current step by checking which conditions are set:
                  - No conditions set: validation/suspend step
                  - SnapshotReady=True, GitCommitted=False: committing step
                  - GitCommitted=True, Healthy=False: health checking step
                  - Complete=True: upgrade finished (check reason for success/failure)
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              healthCheck:
                description: Health check results
                properties:
                  checkedAt:
                    description: When health check was performed
                    format: date-time
                    type: string
                  message:
                    description: Failure message if failed
                    type: string
                  status:
                    description: 'Status: Passed, Failed, Pending'
                    type: string
                type: object
              scaling:
                description: Scaling information (original replica count before scale-down)
                properties:
                  originalReplicas:
                    description: Original replica count before scale-down
                    format: int32
                    type: integer
                  scaledDownAt:
                    description: When scale-down completed
                    format: date-time
                    type: string
                  workloadKind:
                    description: Kind of the scaled workload (Deployment, StatefulSet)
                    type: string
                  workloadName:
                    description: Name of the scaled workload
                    type: string
                type: object
              snapshot:
                description: Snapshot information
                properties:
                  createdAt:
                    description: When snapshots were created
                    format: date-time
                    type: string
                  pvcSnapshots:
                    description: PVC snapshots created
                    items:
                      description: PVCSnapshotInfo records a single PVC snapshot
                      properties:
                        pvcName:
                          type: string
                        snapshotName:
                          type: string
                      required:
                      - pvcName
                      - snapshotName
                      type: object
                    type: array
                  readyAt:
                    description: When snapshots became ready
                    format: date-time
                    type: string
                type: object
              upgrade:
                description: Upgrade details
                properties:
                  completedAt:
                    description: When upgrade completed
                    format: date-time
                    type: string
                  gitCommit:
                    description: Git commit SHA
                    type: string
                  newVersion:
                    description: New version after upgrade
                    properties:
                      chart:
                        description: Chart version (for HelmRelease)
                        type: string
                      images:
                        description: Image versions (for raw deployments or helm values)
                        items:
                          description: ImageInfo contains image version details
                          properties:
                            name:
                              type: string
                            tag:
                              type: string
                          required:
                          - name
                          - tag
                          type: object
                        type: array
                    type: object
                  previousVersion:
                    description: Previous version before upgrade
                    properties:
                      chart:
                        description: Chart version (for HelmRelease)
                        type: string
                      images:
                        description: Image versions (for raw deployments or helm values)
                        items:
                          description: ImageInfo contains image version details
                          properties:
                            name:
                              type: string
                            tag:
                              type: string
                          required:
                          - name
                          - tag
                          type: object
                        type: array
                    type: object
                  startedAt:
                    description: When upgrade started
                    format: date-time
                    type: string
                type: object
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
